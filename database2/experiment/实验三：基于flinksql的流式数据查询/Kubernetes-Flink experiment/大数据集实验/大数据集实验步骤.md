#### 实验步骤

```shell
# master启动k8s集群
sudo kubeadm init --apiserver-advertise-address=[内网ip] --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.96.0.0/12  --pod-network-cidr=10.244.0.0/16

# 如果集群启动失败，通过以下命令重置
sudo kubeadm reset

# slave加入集群（类似于下面）
sudo kubeadm join 172.29.0.4:6443 --token fotxct.cgaqberwypfk3xgz \
--discovery-token-ca-cert-hash sha256:31ea2841587a4338dfcd9312b1bb6c8eabe448afcbad6bd2188392ca7a9289c3

# 创建yaml任务
vim basic.yaml
```

- basic.yaml文件

```yaml
apiVersion: flink.apache.org/v1beta1
kind: FlinkDeployment
metadata:
  namespace: default
  name: largejob
spec:
  image: flink:1.16
  flinkVersion: v1_16
  flinkConfiguration:
    taskmanager.numberOfTaskSlots: "16" # 每个taskmanager有16个task slot
  serviceAccount: flink
  jobManager:
    resource:
      memory: "4096m" # 每个jobmanager分配4G内存
      cpu: 4
    podTemplate:
      spec:
        containers:
          - name: flink-main-container
            volumeMounts:
              - name: my-jar
                mountPath: /opt/flink/largejob
        volumes:
          - name: my-jar
            hostPath:
              path: /home/ubuntu/tableapp/upload   # 本地JAR所在目录
              type: Directory
  taskManager:
    resource:
      memory: "61440m"
      cpu: 16 # 每个taskmanager分配16个CPU
    replicas: 2 # 启动2个taskmanager pod，调度到2个节点
    podTemplate:
      spec:
        containers:
          - name: flink-main-container
            volumeMounts:
              - name: my-jar
                mountPath: /opt/flink/niubi
        volumes:
          - name: my-jar
            hostPath:
              path: /home/ubuntu/tableapp/upload   # 本地JAR所在目录
              type: Directory
  job:
    jarURI: local:///opt/flink/niubi/inputfromfiledemo-1.0.jar
    entryClass: cn.edu.shu.large_result   # 这里填写你的主类全名
    parallelism: 32
```

- java代码编译好后，将jar包和数据集移到同一目录/home/ubuntu/upload下,修改目录及权限为777，并复制到所有节点相同目录下

```shell
# k8s下提交任务
kubectl create -f basic.yaml
# jobmanager节点暴露端口给外来用户访问webui，bacis-example改为name:largejob
kubectl port-forward svc/basic-example-rest 8081 --address 0.0.0.0
# 查看作业运行状态
kubectl logs -f deploy/largejob
# 查看flink容器状态
kubectl get pods
# 删除任务
kubectl delete -f basic.yaml
# 进入容器
kubectl exec -it largejob-7fbc68c96d-cm7qm -- /bin/sh
```

- 最终结果应在本地/home/ubuntu/tableapp/upload下