- 先设置无密码ssh连接
- 然后从[Ubuntu | Docker Docs](https://docs.docker.com/engine/install/ubuntu/)输入以下命令安装docker

```shell
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

# 查看docker可用的版本号
apt-cache madison docker-ce | awk '{ print $3 }'
VERSION_STRING=5:19.03.9~3-0~ubuntu-focal # 选择相应的版本号
sudo apt-get install docker-ce=$VERSION_STRING docker-ce-cli=$VERSION_STRING containerd.io docker-buildx-plugin docker-compose-plugin

sudo docker run hello-world
```

- 安装k8s

  - 先换源成国内阿里的

    ```shell
    sudo apt-get install -y apt-transport-https
    sudo curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add - 
    sudo vim /etc/apt/sources.list.d/kubernetes.list
    # 插入以下文本
    deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
    
    sudo apt-get update
    # 可以看到已经添加到库名单了
    ```

  - 查看版本号后，安装对应版本

    ```shell
    # 列出各个版本号
    sudo apt-cache madison kubeadm
    
    sudo apt-get install -y kubelet=1.18.0-00 kubeadm=1.18.0-00 kubectl=1.18.0-00
    
    # 输出版本号，验证安装成功
    kubeadm version
    ```
  
- 删除known_hosts（用户访问记录）

- k8s集群初始化

```shell
# 关闭虚拟内存
sudo swapoff -a

# 初始化单节点集群（address切换成自己的内网ip）
sudo kubeadm init --apiserver-advertise-address=172.19.0.6 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.96.0.0/12  --pod-network-cidr=10.244.0.0/16

# 看到有token就成功了

# 如何重启k8s
sudo kubeadm reset
sudo netstat -tulnp | grep -E '6443|10250|10257|10259'
sudo kill 5902 5923 6004
sudo rm -rf /etc/kubernetes /var/lib/etcd
```

#### 第四周实验部分

每个docker以pod为单位存储在container中，pod就是主机加上计算资源。通过service形式暴露端口，外层deployment管理pod

第三周：单台服务器租借，ssh无密码连接，docker安装，单机版k8s安装，镜像制作

第四周：租借三台服务器，启动k8s集群，部署redis,部署网页前端，负载均衡和容灾

- 先在主节点上启动k8s，再在两个slave1,2中关闭虚存后粘贴以下命令(在启动成功后的最后3行)

```shell
sudo kubeadm join 172.29.0.4:6443 --token fotxct.cgaqberwypfk3xgz \
--discovery-token-ca-cert-hash sha256:31ea2841587a4338dfcd9312b1bb6c8eabe448afcbad6bd2188392ca7a9289c3
```

- 主节点上

```shell
# 配置 kubectl 的客户端访问权限
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 列出集群中所有命名空间下的 Pod
kubectl get pods --all-namespaces

# 下载网络插件
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

# 查看结点状态
kubectl get nodes
```

- 开始部署redis

```shell
# 将redis-follower-deployment.yaml
# redis-leader-deployment.yaml
# redis-follower-service.yaml     
# redis-leader-service.yaml

# 复制4个文件内容
vim redis-leader-deployment.yaml
vim redis-follower-deployment.yaml
vim redis-follower-service.yaml
vim redis-leader-service.yaml

# 应用4个文件
kubectl apply -f redis-leader-deployment.yaml
kubectl apply -f redis-follower-deployment.yaml
kubectl apply -f redis-follower-service.yaml
kubectl apply -f redis-leader-service.yaml

# 查看pods，应该有3个redis
kubectl get pods
############
# 控制5个副本
kubectl scale deployment redis-follower --replicas=5

# 杀死一个pod后，还会自动创建一个pod，保证数量为5个
kubectl delete pod redis-follower-5954996669-ptr5l
kubectl get pods
############

# 进入一个容器（虚拟机）
kubectl exec -it redis-leader-6d7765b8f6-njpgq -- bash

# 创建前端配置文件
vim frontend-deployment.yaml
vim frontend-service.yaml

# 应用该文件
kubectl apply -f frontend-service.yaml
kubectl apply -f frontend-deployment.yaml

kubectl get services

```

截图：1.安装docker结束后，列出docker版本号

2.sudo docker run hello-world

3.sudo apt-cache madison kubeadm

4. 初始化k8s集群成功

   Your Kubernetes control-plane has initialized successfully!

   To start using your cluster, you need to run the following as a regular user:

     mkdir -p $HOME/.kube
     sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
     sudo chown $(id -u):$(id -g) $HOME/.kube/config

   You should now deploy a pod network to the cluster.
   Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
     https://kubernetes.io/docs/concepts/cluster-administration/addons/

   Then you can join any number of worker nodes by running the following on each as root:

   kubeadm join 172.29.0.8:6443 --token v9ulm9.p75raq7i7wzlb0is \
       --discovery-token-ca-cert-hash sha256:c8083f4039f4c203087bc0de1fbb00f765bfbce9b385217aa131c0c14309a1b6

5. 证明所有容器状态在running，kube-flannel是3个

ubuntu@master:~$ kubectl get pods --all-namespaces
NAMESPACE      NAME                             READY   STATUS    RESTARTS   AGE
kube-flannel   kube-flannel-ds-96fp7            1/1     Running   0          53s
kube-flannel   kube-flannel-ds-dw9c2            1/1     Running   0          53s
kube-flannel   kube-flannel-ds-r2s6r            1/1     Running   0          53s
kube-system    coredns-7ff77c879f-6bnts         1/1     Running   0          7m18s
kube-system    coredns-7ff77c879f-q5s8x         1/1     Running   0          7m18s
kube-system    etcd-master                      1/1     Running   0          7m27s
kube-system    kube-apiserver-master            1/1     Running   0          7m27s
kube-system    kube-controller-manager-master   1/1     Running   0          7m27s
kube-system    kube-proxy-2bp2v                 1/1     Running   0          7m18s
kube-system    kube-proxy-ptvdr                 1/1     Running   0          5m8s
kube-system    kube-proxy-vcv95                 1/1     Running   0          4m55s
kube-system    kube-scheduler-master            1/1     Running   0          7m27s

6. ubuntu@master:~$ kubectl get services
   NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
   frontend         NodePort    10.105.48.27     <none>        80:31812/TCP   3s
   kubernetes       ClusterIP   10.96.0.1        <none>        443/TCP        30m
   redis-follower   ClusterIP   10.97.111.78     <none>        6379/TCP       19m
   redis-leader     ClusterIP   10.107.174.145   <none>        6379/TCP       18m
7. 前端网页，输入姓名学号

